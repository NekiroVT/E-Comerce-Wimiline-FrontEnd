<div class="envio-container">

  <!-- üö© Paso 1: Selecci√≥n de tipo -->
  <div *ngIf="modo === 'seleccion'" class="opciones-envio">
    <h3>¬øC√≥mo quieres tu env√≠o?</h3>
    <div class="grupo-botones">
      <button (click)="elegirDomicilio()">Env√≠o a Domicilio</button>
      <button (click)="elegirTolva()">Env√≠o a Tolva</button>
    </div>
  </div>

  <!-- üö© Paso 2: Lista de direcciones -->
  <div *ngIf="modo === 'domicilio'" class="lista-direcciones">
    <h3>Elige tu direcci√≥n de entrega</h3>

    <button (click)="nuevaDireccion()">‚ûï Nueva Direcci√≥n</button>

    <div *ngIf="direcciones.length === 0">
      <p>No tienes direcciones registradas.</p>
    </div>

    <div *ngFor="let dir of direcciones" class="direccion-card">
      <label class="direccion-item">
        <input
          type="radio"
          name="direccion"
          [value]="dir.id"
          [(ngModel)]="direccionSeleccionadaId" />
        <span class="direccion-text">
          {{ dir.direccion }} ‚Äî {{ dir.referencia }}
        </span>
        <button type="button" (click)="verEnMapa(dir)">üó∫Ô∏è Ver Mapa</button>
      </label>
    </div>

    <button (click)="confirmarDireccion()" [disabled]="!direccionSeleccionadaId">
      Continuar con esta direcci√≥n
    </button>
  </div>

  <!-- üö© Paso 3: Formulario para crear -->
  <div *ngIf="modo === 'crear'" class="form-direccion">
    <h3>Crear Nueva Direcci√≥n</h3>

    <form [formGroup]="formDireccion" (ngSubmit)="guardarDireccion()">

      <label>Direcci√≥n
        <input formControlName="direccion" placeholder="Ej: Jr. Los Olivos 123" />
      </label>

      <label>Referencia
        <input formControlName="referencia" placeholder="Ej: Puerta azul" />
      </label>

      <label>Destinatario
        <input formControlName="destinatario" placeholder="Ej: Elias Crack" />
      </label>

      <button type="button" (click)="abrirSelectorUbicacion()">
        üìç {{ formDireccion.value.latitud && formDireccion.value.longitud ? 'Cambiar Ubicaci√≥n' : 'Elegir Ubicaci√≥n' }}
      </button>

      <button type="submit" [disabled]="formDireccion.invalid">Guardar Direcci√≥n</button>
    </form>
  </div>

  <!-- üö© Paso 4: Vista de mapa -->
  <div *ngIf="modo === 'ver-mapa'" class="ver-mapa-container">
    <app-mapa
      [latitud]="direccionAMostrarEnMapa.latitud"
      [longitud]="direccionAMostrarEnMapa.longitud"
      [direccion]="direccionAMostrarEnMapa.direccion">
    </app-mapa>

    <button class="btn-volver" (click)="volverALista()">‚¨ÖÔ∏è Volver</button>
  </div>

  <!-- üö© Paso 5: Selector de ubicaci√≥n -->
  <div *ngIf="modo === 'elegir-ubicacion'" class="selector-ubicacion-container">
    <h3>Selecciona la Ubicaci√≥n</h3>

    <google-map
      height="400px"
      width="100%"
      [center]="center"
      [zoom]="15"
      (mapClick)="marcarUbicacion($event)">
      <map-marker *ngIf="markerPosition" [position]="markerPosition"></map-marker>
    </google-map>

    <button (click)="confirmarUbicacion()">‚úÖ Confirmar Ubicaci√≥n</button>
    <button (click)="cerrarSelectorUbicacion()">‚ùå Cancelar</button>
  </div>

  <!-- üö© Paso 6: Vista Preview despu√©s de calcular env√≠o -->
  <div *ngIf="modo === 'preview'" class="preview-envio">
    <h3>Resumen de Env√≠o</h3>

    <div *ngFor="let envio of previewEnvios.envios" class="envio-item">
      <p><strong>Sede:</strong> {{ envio.nombreSede }}</p>
      <p><strong>Distancia:</strong> {{ envio.distanciaKm | number:'1.2-2' }} km</p>
      <p><strong>Precio:</strong> S/ {{ envio.precioEnvio }}</p>
      <p><strong>Tiempo Estimado:</strong> {{ envio.tiempoEstimadoDias }} d√≠as</p>
      <p><strong>Productos:</strong></p>
      <ul>
       <li *ngFor="let nombre of envio.productosNombres">
    {{ nombre }}
  </li>
      </ul>
    </div>

    <p class="total-envio">
      <strong>Total Env√≠o:</strong> S/ {{ totalEnvio }}
    </p>

    <button (click)="irAPagar()">Ir a Pagar</button>
  </div>

</div>
